<!-- Chatbot Widget Integration -->
<script src="https://widget.lamatic.ai/chat/emojiPicker.js"></script>
<script src="https://widget.lamatic.ai/chat/index.js"></script>
<script>
  const CHAT_DIALOG_CONFIG = {
    widgetTypes: 1,
    botName: "Smart Guide",
    suggestions: [
      "NovaBot is an AI-powered assistant developed for educational, informational, and productivity purposes only..."
    ],
    policyUrl: "https://lamatic.ai/docs/legal/privacy-policy",
    apiUrl: "https://sandbox-inference-api.lamatic.tech",
    chatHeaderBgColor: "#4D888B",
    userMessageBgColor: "#E0F7FA",
    userMessageTextColor: "blue",
    agentMessageBgColor: "#F1F8E9",
    agentMessageTextColor: "#1B5E20",
    position: "right",
    floatingButtonIcon: "ðŸ’¬",
    userId: "67fe38972de6a53ce50b39a6",
    headerTextColor: "#fff",
    errorMessage: "Some error has taken place",
    context: "NovaBot is an AI-powered assistant developed for educational, informational, and productivity purposes only...",
    prompts: "NovaBot is an AI-powered assistant developed for educational, informational, and productivity purposes only...",
    creatorName: "z",
    projectId: "55c3d813-c713-4ef1-a7e0-477bcaed7d77",
    workflowId: "7ef12020-7231-48ae-ba08-ba63051a961a",
    legalNotice: "NovaBot is an AI-powered assistant developed for educational, informational, and productivity purposes only...",
    certainty: 40,
    imageUrl: "http://127.0.0.1:7010/uploads/chatbot/67ee79d5af2d674604f12cdb/1744795034975_2825805093793046.jpg"
  };

  window.addEventListener("DOMContentLoaded", () => {
    const hostname = window.location.href;

    registerHostname(hostname);
    setupDailyVerification(hostname);

    // Initialize chatbot
    new ChatDialog(CHAT_DIALOG_CONFIG);

    // Update placeholder after chatbot loads
    setTimeout(updatePlaceholder, 300);

    // Start monitoring if chatbot is removed
    observeChatbotRemoval(hostname);
  });

  function registerHostname(hostname) {
    fetch(`http://127.0.0.1:7010/business/add-hostname-to-domains/${CHAT_DIALOG_CONFIG.userId}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2N2VlNzlkNWFmMmQ2NzQ2MDRmMTJjZGIiLCJpYXQiOjE3NDQ3OTI2MTZ9.WfzBu8Wg36rMU3OndCEKohIHd8VlZyKLdGt-qkYL8b0"
      },
      body: JSON.stringify({ hostname })
    })
    .then(res => res.ok ? console.log("Hostname registered") : console.error("Failed to register hostname"))
    .catch(err => console.error("Registration error:", err));
  }

  function unregisterHostname(hostname) {
    fetch(`http://127.0.0.1:7010/business/remove-hostname-from-domains/${CHAT_DIALOG_CONFIG.userId}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2N2VlNzlkNWFmMmQ2NzQ2MDRmMTJjZGIiLCJpYXQiOjE3NDQ3OTI2MTZ9.WfzBu8Wg36rMU3OndCEKohIHd8VlZyKLdGt-qkYL8b0"
      },
      body: JSON.stringify({ hostname })
    })
    .then(res => res.ok ? console.log("Hostname removed successfully") : console.error("Failed to remove hostname"))
    .catch(err => console.error("Unregistration error:", err));
  }

  function setupDailyVerification(hostname) {
    const key = `lastVerification_${hostname}`;
    const now = new Date();
    const last = localStorage.getItem(key) ? new Date(localStorage.getItem(key)) : null;

    if (!last || (now - last) > 6 * 1000) {
      verifyDomainStatus(hostname);
      localStorage.setItem(key, now.toISOString());
    }

    setInterval(() => {
      const lastTime = new Date(localStorage.getItem(key));
      const currentTime = new Date();

      if ((currentTime - lastTime) > 6 * 1000) {
        verifyDomainStatus(hostname);
        localStorage.setItem(key, currentTime.toISOString());
      }
    }, 6 * 1000); // every 6 seconds (demo purpose, usually should be 1 hour = 3600*1000)
  }

  function verifyDomainStatus(hostname) {
    console.log("Verifying domain:", hostname);
    // you can add real verification API call here
  }

  function updatePlaceholder() {
    const input = document.querySelector('.lamatic-chat-input');
    const privacy = document.querySelector('.lamatic-privacy-policy');

    if (input) input.placeholder = "Type a reply...";
    if (privacy) privacy.innerHTML = "Powered by <strong>Nemo</strong>";
  }

  function observeChatbotRemoval(hostname) {
    const chatbotElement = document.querySelector('.lamatic-chat-wrapper'); // Main chatbot wrapper class

    if (!chatbotElement) {
      console.error("Chatbot element not found <!-- Chatbot Widget Integration -->
<script src="https://widget.lamatic.ai/chat/emojiPicker.js"></script>
<script src="https://widget.lamatic.ai/chat/index.js"></script>
<script>
  const CHAT_DIALOG_CONFIG = {
    widgetTypes: 1,
    botName: "Smart Guide",
    suggestions: [
      "NovaBot is an AI-powered assistant developed for educational, informational, and productivity purposes only..."
    ],
    policyUrl: "https://lamatic.ai/docs/legal/privacy-policy",
    apiUrl: "https://sandbox-inference-api.lamatic.tech",
    chatHeaderBgColor: "#4D888B",
    userMessageBgColor: "#E0F7FA",
    userMessageTextColor: "blue",
    agentMessageBgColor: "#F1F8E9",
    agentMessageTextColor: "#1B5E20",
    position: "right",
    floatingButtonIcon: "ðŸ’¬",
    userId: "67fe38972de6a53ce50b39a6",
    headerTextColor: "#fff",
    errorMessage: "Some error has taken place",
    context: "NovaBot is an AI-powered assistant developed for educational, informational, and productivity purposes only...",
    prompts: "NovaBot is an AI-powered assistant developed for educational, informational, and productivity purposes only...",
    creatorName: "z",
    projectId: "55c3d813-c713-4ef1-a7e0-477bcaed7d77",
    workflowId: "7ef12020-7231-48ae-ba08-ba63051a961a",
    legalNotice: "NovaBot is an AI-powered assistant developed for educational, informational, and productivity purposes only...",
    certainty: 40,
    imageUrl: "http://127.0.0.1:7010/uploads/chatbot/67ee79d5af2d674604f12cdb/1744795034975_2825805093793046.jpg"
  };

  window.addEventListener("DOMContentLoaded", () => {
    const hostname = window.location.hostname;

    registerHostname(hostname);
    setupDailyVerification(hostname);

    // Initialize chatbot
    new ChatDialog(CHAT_DIALOG_CONFIG);

    // Update placeholder after chatbot loads
    setTimeout(updatePlaceholder, 300);

    // Start monitoring if chatbot is removed
    observeChatbotRemoval(hostname);
  });

  function registerHostname(hostname) {
    fetch(`http://127.0.0.1:7010/business/add-hostname-to-domains/${CHAT_DIALOG_CONFIG.userId}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2N2VlNzlkNWFmMmQ2NzQ2MDRmMTJjZGIiLCJpYXQiOjE3NDQ3OTI2MTZ9.WfzBu8Wg36rMU3OndCEKohIHd8VlZyKLdGt-qkYL8b0"
      },
      body: JSON.stringify({ hostname })
    })
    .then(res => res.ok ? console.log("Hostname registered") : console.error("Failed to register hostname"))
    .catch(err => console.error("Registration error:", err));
  }

  function unregisterHostname(hostname) {
    fetch(`http://127.0.0.1:7010/business/remove-hostname-from-domains/${CHAT_DIALOG_CONFIG.userId}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2N2VlNzlkNWFmMmQ2NzQ2MDRmMTJjZGIiLCJpYXQiOjE3NDQ3OTI2MTZ9.WfzBu8Wg36rMU3OndCEKohIHd8VlZyKLdGt-qkYL8b0"
      },
      body: JSON.stringify({ hostname })
    })
    .then(res => res.ok ? console.log("Hostname removed successfully") : console.error("Failed to remove hostname"))
    .catch(err => console.error("Unregistration error:", err));
  }

  function setupDailyVerification(hostname) {
    const key = `lastVerification_${hostname}`;
    const now = new Date();
    const last = localStorage.getItem(key) ? new Date(localStorage.getItem(key)) : null;

    if (!last || (now - last) > 6 * 1000) {
      verifyDomainStatus(hostname);
      localStorage.setItem(key, now.toISOString());
    }

    setInterval(() => {
      const lastTime = new Date(localStorage.getItem(key));
      const currentTime = new Date();

      if ((currentTime - lastTime) > 6 * 1000) {
        verifyDomainStatus(hostname);
        localStorage.setItem(key, currentTime.toISOString());
      }
    }, 6 * 1000); // every 6 seconds (demo purpose, usually should be 1 hour = 3600*1000)
  }

  function verifyDomainStatus(hostname) {
    console.log("Verifying domain:", hostname);
    // you can add real verification API call here
  }

  function updatePlaceholder() {
    const input = document.querySelector('.lamatic-chat-input');
    const privacy = document.querySelector('.lamatic-privacy-policy');

    if (input) input.placeholder = "Type a reply...";
    if (privacy) privacy.innerHTML = "Powered by <strong>Nemo</strong>";
  }

  function observeChatbotRemoval(hostname) {
    const chatbotElement = document.querySelector('.lamatic-chat-wrapper'); // Main chatbot wrapper class

    if (!chatbotElement) {
      console.error("Chatbot element not found for monitoring.");
      return;
    }

    const observer = new MutationObserver((mutationsList) => {
      for (const mutation of mutationsList) {
        for (const removedNode of mutation.removedNodes) {
          if (removedNode.contains(chatbotElement)) {
            console.log("Chatbot removed! Unregistering hostname...");
            unregisterHostname(hostname);
            observer.disconnect();
            return;
          }
        }
      }

      // Extra safety: check if chatbot element is still in the document
      if (!document.body.contains(chatbotElement)) {
        console.log("Chatbot element no longer in DOM! Unregistering hostname...");
        unregisterHostname(hostname);
        observer.disconnect();
      }
    });

    observer.observe(document.body, { childList: true, subtree: true });
  }
</script>
 monitoring.");
      return;
    }

    const observer = new MutationObserver((mutationsList) => {
      for (const mutation of mutationsList) {
        for (const removedNode of mutation.removedNodes) {
          if (removedNode.contains(chatbotElement)) {
            console.log("Chatbot removed! Unregistering hostname...");
            unregisterHostname(hostname);
            observer.disconnect();
            return;
          }
        }
      }

      // Extra safety: check if chatbot element is still in the document
      if (!document.body.contains(chatbotElement)) {
        console.log("Chatbot element no longer in DOM! Unregistering hostname...");
        unregisterHostname(hostname);
        observer.disconnect();
      }
    });

    observer.observe(document.body, { childList: true, subtree: true });
  }
</script>
